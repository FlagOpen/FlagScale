

#  Install FlagScale

Clone FlagScale code from github.

If you don't have access to the international internet, import FlagScale project on [gitee](https://gitee.com/), then clone from gitee.

```sh
git clone https://github.com/FlagOpen/FlagScale.git
cd FlagScale/
```

Install train and inference env according to [README](https://github.com/FlagOpen/FlagScale/blob/main/README.md) 

# Download Model

```sh
git lfs install

mkdir -p /share/pi0
cd /share/pi0
git clone https://huggingface.co/lerobot/pi0_base

mkdir -p /share/paligemma-3b-pt-224
cd /share/paligemma-3b-pt-224
git clone https://huggingface.co/google/paligemma-3b-pt-224
```

If you don't have access to the international internet, download from modelscope.

```sh
modelscope download --model lerobot/pi0 --local_dir /share/pi0
modelscope download --model google/paligemma-3b-pt-224 --local_dir /share/paligemma-3b-pt-224
```


# Download Statistics

```sh
mkdir -p /share/lerobot/aloha_mobile_cabinet
cd /share/lerobot/aloha_mobile_cabinet
git clone https://huggingface.co/datasets/lerobot/aloha_mobile_cabinet
```

If you don't have access to the international internet, download from modelscope.

```sh
modelscope download --dataset lerobot/aloha_mobile_cabinet --local_dir /share/lerobot/aloha_mobile_cabinet
```

# Training

## Prepare Dataset

FlagScale uses WebDataset format and Megatraon.Energon data loader, you need process your data first.

For example: [demo_0913_n2](https://gitee.com/hchnr/flag-scale/tree/robotics_dataset/demo_0913_n2/wds-1).

The directory structure is as follows.
- build_dep.sh: Copy .npy and .jpg files from production environment to ./deps
- demo_0913_n2.jsonl: A single timestep, including: task(str), images(.jpg), action(.npy), state(.npy)
- deps: .npy and .jpg files
- wds-1: Data in webdataset format (DP=1), generated by tools/datasets/qwenvl/convert_pi0.py

```
|-- build_dep.sh
|-- demo_0913_n2.jsonl
|-- deps
|   `-- share
|       `-- project
|           `-- dumengfei
|               `-- data
|                   `-- agilex_data_0905_F3A1C30P0
|                       `-- agilex_train_data_twin
|                           |-- robomind_agx_Place_the_apple_in_the_bowl
|                           |   |-- action_token
|                           |   |   `-- RoboBrain_Robotic_train_463
|                           |   |       |-- action_eepose_64.npy
|                           |   |       |-- action_eepose_token_64.npy
|                           |   |       |-- action_qpos_64.npy
|                           |   |       |-- action_qpos_token_64.npy
|                           |   |       |-- state_eepose_64.npy
|                           |   |       `-- state_qpos_64.npy
|                           |   `-- images
|                           |       `-- RoboBrain_Robotic_train_463
|                           |           |-- cam_high_64.jpg
|                           |           |-- left_wrist_64.jpg
|                           |           `-- right_wrist_64.jpg
|                           `-- xinlong_agx_Place_it_in_front_of_the_coffee_machine
|                               |-- action_token
|                               |   `-- RoboBrain_Robotic_newdragon_train_2537
|                               |       |-- action_eepose_1905.npy
|                               |       |-- action_eepose_token_1905.npy
|                               |       |-- action_qpos_1905.npy
|                               |       |-- action_qpos_token_1905.npy
|                               |       |-- state_eepose_1905.npy
|                               |       `-- state_qpos_1905.npy
|                               `-- images
|                                   `-- RoboBrain_Robotic_newdragon_train_2537
|                                       |-- cam_high_1905.jpg
|                                       |-- left_wrist_1905.jpg
|                                       `-- right_wrist_1905.jpg
`-- wds-1
    |-- pretrain-0.tar
    `-- pretrain-0.tar.idx
```

Generate Data in webdataset format (DP=2)

```sh
git archive --remote=git@gitee.com:hchnr/flag-scale.git robotics_dataset demo_0913_n2/ | tar -xv -C .

mkdir -p /share/
cp -r ./demo_0913_n2/deps/share/* /share/

python tools/datasets/qwenvl/convert_pi0.py \
    --dataset-root=./demo_0913_n2 \
    --output-root=./demo_0913_n2 \
    --json=demo_0913_n2.jsonl \
    --train-split 1 \
    --val-split 0 \
    --images-key=image \
    --videos-key=video \
    --vision-root='' \
    --shuffle-tars \
    --num-workers=1 \
    --max-samples-per-tar 100000 \
    --dp-size 2
```



## Edit Config

```sh
cd FlagScale/
vim examples/pi0/conf/train/pi0.yaml
```
Change 4 fields:
- model.checkpoint_dir -> /share/pi0
- model.stat_path -> /share/lerobot/aloha_mobile_cabinet/meta/stats.json
- data.tokenizer_path -> /share/paligemma-3b-pt-224
- data.data_path -> /share/demo_0913_n2/wds-1

## Start Training
```sh
cd FlagScale/
python run.py --config-path ./examples/pi0/conf --config-name train action=run
```

# Inference

## Edit Config

```sh
cd FlagScale/
vim examples/pi0/conf/inference/pi0.yaml
```

Change 3 fields:
- engine.model -> /share/pi0
- engine.stat_path -> /share/lerobot/aloha_mobile_cabinet/meta/stats.json
- engine.tokenizer -> /share/paligemma-3b-pt-224

## Start Inference
```sh
cd FlagScale/
python run.py --config-path ./examples/pi0/conf --config-name inference action=run
```

# Serving

## Edit Config

```sh
cd FlagScale/
vim examples/pi0/conf/serve/pi0.yaml
```

Change 3 fields:
- engine.model -> /share/pi0
- engine.stat_path -> /share/lerobot/aloha_mobile_cabinet/meta/stats.json
- engine.tokenizer -> /share/paligemma-3b-pt-224

## Run Serving

```sh
cd FlagScale/
python run.py --config-path ./examples/pi0/conf --config-name serve action=run
```

# Test Server with Client

Download test images:

```sh
cd FlagScale/
wget https://gitee.com/hchnr/flag-scale/blob/robotics_dataset/orbbec_0_latest.jpg
wget https://gitee.com/hchnr/flag-scale/blob/robotics_dataset/orbbec_1_latest.jpg
wget https://gitee.com/hchnr/flag-scale/blob/robotics_dataset/orbbec_2_latest.jpg
```

Run client:

```sh
cd FlagScale/
python examples/pi0/client_pi0.py \
--host 127.0.0.1 \
--port 5000 \
--base-img orbbec_0_latest.jpg \
--left-wrist-img orbbec_1_latest.jpg \
--right-wrist-img orbbec_2_latest.jpg \
--num-steps 20
```
