name: All Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ${{ github.event.pull_request.number }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  set-env:
    runs-on: ubuntu-latest
    outputs:
      ci_image: ${{ steps.set-env.outputs.ci_image }}  # Declare output variable
    steps:
      - name: Set Environment Variable
        id: set-env  # Assign an ID to this step
        run: |
          echo "ci_image=localhost:5000/flagscale:cuda12.8.1-cudnn9.7.1-python3.12-torch2.7.0-time_2506261134" >> $GITHUB_OUTPUT  # Set output variable

  functional-tests-inference-pipeline:
    needs:
      - set-env
      # - functional-tests-hetero
    uses: ./.github/workflows/functional-tests.yml
    strategy:
      matrix:
        task:
          - Qwen3-4B
    name: "inference-${{ matrix.task }}"
    with:
      task: ${{ matrix.task }}
      type: inference-pipeline
      flaggems: disable
      image: ${{ needs.set-env.outputs.ci_image }}
