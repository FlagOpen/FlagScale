name: All Tests Metax

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  set-env-metax:
    runs-on: ubuntu-latest
    outputs:
      ci_image_metax: ${{ steps.set-env.outputs.ci_image }} # Declare output variable
    steps:
      - name: Set Environment Variable
        id: set-env-metax # Assign an ID to this step
        run: |
          echo "ci_image_metax=localhost:5000/flagscale:maca.ai2.33.0.13-torch2.6-py310-ubuntu22.04-amd64-time2507211649" >> $GITHUB_OUTPUT  # Set output variable

  functional-tests-inference-metax:
    needs:
      - set-env-metax
    uses: ./.github/workflows/functional-tests-metax.yml
    strategy:
      matrix:
        task:
          - deepseek
          - qwen3
          # - deepseek_flaggems   # TODO: need fix
          # - qwen3_flaggems      # TODO: need fix
    name: "inference-${{ matrix.task }}-metax"
    with:
      task: ${{ matrix.task }}
      type: inference
      image: ${{ needs.set-env-metax.outputs.ci_image_metax }}

  # Check All Tests
  all-tests-metax:
    needs:
      - functional-tests-inference-metax
    runs-on: ubuntu-latest
    steps:
      - name: All Tests Completed
        run: echo "All tests completed successfully!"
